# Наименование проекта

Плагин для формирования табеля сотрудников для бухгалтерии

## Цель проекта

Реализовать плагин для Easy Redmine для учёта финансов по проектам и сотрудникам компании

## Исходная информация

* сервер Debian GNU/Linux 9;
* веб-приложение системы контроля и управления проектами Easy Redmine 2018.1.1;
* база данных MySQL 5.7.

## Что нужно сделать

Реализовать небольшой модуль формирования табеля сотрудников для бухгалтерии, где будут произведен учёт затраченного времени сотрудника и его занятости.

Доступ к основным настройкам и просмотру информации в отдельной вкладке "Табель для бухгалтерии" в меню "Прочее" в веб-версии Easy Redmine. Необходимо предусмотреть наличие доступа в зависимости от роли пользователя.
Должно открываться [главное окно (Табель рабочей занятости сотрудников по дням)](#страница-табель-рабочей-занятости-сотрудников-по-дням), где справа сверху будет несколько кнопок, при нажатии на которые будет открываться соответствующее окно:

* [Табель рабочей занятости сотрудников по дням](#страница-табель-рабочей-занятости-сотрудников-по-дням) (оно же главное окно);
* [Табель рабочей занятости сотрудников по проектам](#страница-табель-рабочей-занятости-сотрудников-по-проектам);
* [Сгенерировать файл табеля для бухгалтерии](#кнопка-сгенерировать-файл-табеля-для-бухгалтерии).

### Страница "Табель рабочей занятости сотрудников по дням"

Представляет собой [страницу](https://www.figma.com/design/Am20t3KqytONawMtcyKjyw/Plugin-Tabel-employees?node-id=0-1) с информацией в табличном виде, где отображена занятость сотрудников за календарный месяц.

Строки - сотрудники (по умолчанию выбран фильтр "ИЦ СПб"), столбцы - календарные дни месяца от первого до последнего (по умолчанию отображается текущий месяц).  
В таблицу попадают обязательно все подходящие под выбранный фильтр как и сотрудники, которые не являются заблокированными, так и заблокированные сотрудники, у которых за выбранный месяц есть или какая-либо занятость (больничный, командировка и др.), или есть затраченное время на один из проектов.

В таблице отображаются данные по определённым правилам:

1. При наличии у сотрудника командировки, отпуска, больничного и отгула за свой счёт в этот день выводится текст "к", "отп", "б/л" и "б/с" соответственно;
2. Если день является рабочим согласно производственному календарю (для 40-часовой рабочей недели) и сотрудник не имеет в данный день ни одного статуса из пункта 1, записывается кол-во затраченного времени в часах (целое значение):
  
    * для сотрудников на полной ставке - сумма затраченного времени за данный день, округленная до кол-ва рабочих часов согласно производственному календарю для 40-часовой недели. Например, 8 (ч.) для обычного рабочего дня или 7 (ч.) для сокращённого рабочего дня;
    * для сотрудников на неполной ставке - сумма затраченного времени за данный день, округленная до кол-ва рабочих часов согласно производственному календарю для 40-часовой недели, умноженного на ставку сотрудника. Например, если сотрудник работает на половине ставки (0,5), то кол-во затраченного времени будет округлено для стандартного рабочего дня до $8 \cdot 0,5 = 4$ (ч.).

3. Для нерабочих/праздничных дней не проставляется никакое затраченное время (просто пустое значение) за исключением случаев из пункта 1.

Пример заполнения таблицы показан ниже:
![Таблица рабочей занятости сотрудников по дням](/docs/table_attendance_employees.png)

В таблице можно:

* выбрать любой нужный месяц;
* фильтровать и сортировать значения списка сотрудников (выбор группы сотрудников или сотрудников по отдельности);
* выбрать какие столбцы атрибутов "Пользователя" будут показываться в таблице (Фамилия, Имя, Отчество, должность и т.п.).

Внизу справа есть кнопки экспорта данной таблицы в формате xlsx, pdf: ![Footer export](/docs/footer_export.png)

### Страница "Табель рабочей занятости сотрудников по проектам"

Представляет собой [страницу](https://www.figma.com/design/Am20t3KqytONawMtcyKjyw/Plugin-Tabel-employees?node-id=37-6) с информацией в табличном виде, где отображена занятость сотрудников за календарный месяц по каждому отдельному проекту.

Строки - все проекты, по которым есть хоть одна запись затраченного времени, столбцы - сотрудники (по умолчанию выбран фильтр "ИЦ СПб").  
По умолчанию отображаются данные за текущий месяц.

В таблицу попадают обязательно все подходящие под выбранный фильтр как и сотрудники, которые не являются заблокированными, так и заблокированные сотрудники, у которых за выбранный месяц есть или какая-либо занятость (больничный, командировка и др.), или есть затраченное время на один из проектов.

![Таблица затраченного времени сотрудников по проектам](/docs/table_work_hours_employees_projects.png)

Данными в таблице является процентное соотношение траты рабочих часов на проекты от месячной нормы. Для каждого проекта по каждому сотруднику в каждый конкретный день данное процентное соотношение вычисляется следующим образом (округление до 2 знаков после запятой):
$$\frac{NormalDayWorkHours \cdot ProjectWorkHours \cdot 100}{SumDayWorkHours \cdot MonthWorkHours},$$
где $NormalDayWorkHours$ - норма количества рабочих часов в этом рабочем дне месяца;
$ProjectWorkHours$ - количество затраченного времени сотрудника на проекте в этот день;
$SumDayWorkHours$ - сумма затраченного времени сотрудника за этот день;
$MonthWorkHours$ - количество рабочих часов выбранного месяца для 40-часовой рабочей недели согласно производственному календарю.  
В случае отсутствия затраченного времени на каком-либо проекте ставится прочерк ("-").

Внизу справа есть кнопки экспорта данной таблицы в формате xlsx, pdf.

### Кнопка "Сгенерировать файл табеля для бухгалтерии"

Нажатие данной кнопки открывает [новое окно](https://www.figma.com/design/Am20t3KqytONawMtcyKjyw/Plugin-Tabel-employees?node-id=38-20), где есть возможность сгенерировать и экспортировать файл табеля сотрудников для бухгалтерии с возможность параметризации.
Можно выбрать:

* группы сотрудников (по умолчанию должны быть выбраны группы "ИЦ СПб", "Программисты" и "ЭП");
* год и месяц, за который будет сделан файл табеля (по умолчанию, текущий месяц текущего года);
* период месяца через раскрывающийся список: за первую половину выбранного месяца ("Половина месяца") или за полный выбранный месяц ("Весь месяц"). По умолчанию, если текущее число месяца не превышает 20, то автоматически выбирается "Половина месяца", иначе же - "Весь месяц".

Под выбранными параметрами будет находиться кнопка "Сгенерировать в формате xlsx", при нажатии на которую будет предложено сохранение сгенерированного файла на компьютер.

Экспортируемый файл представляет собой файл с расширением "xlsx", где для каждой выбранной группы сотрудников на отдельных вкладках для выбранного месяца будут записаны таблицы со страниц ["Табель рабочей занятости сотрудников по дням"](#страница-табель-рабочей-занятости-сотрудников-по-дням) и ["Табель рабочей занятости сотрудников по проектам"](#страница-табель-рабочей-занятости-сотрудников-по-проектам).  
Например, для выбранных по умолчанию 3 групп сотрудников в файле будут находиться 6 вкладок (по 2 вкладки на каждую группу сотрудников).

Наименования вкладок должны строиться следующим образом:  
"Имя группы сотрудников" + " по дням" / " по проектам".
