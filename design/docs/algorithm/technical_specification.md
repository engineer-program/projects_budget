# Наименование проекта

Плагин для учёта финансов по проектам и сотрудникам компании

## Цель проекта

Реализовать плагин для Easy Redmine для учёта финансов по проектам и сотрудникам компании

## Исходная информация

* сервер Debian GNU/Linux 9;
* Ruby версии 2.5.0p0 (2017-12-25 revision 61468);
* веб-приложение системы контроля и управления проектами Easy Redmine 2018.1.1;
* база данных MySQL 5.7.

## Уточнения по работе с БД

* для всех существующих таблиц разрешается только выборка данных;
* разрешается создание необходимых новых таблиц и работа с ними;
* нет строгих требований по виду запросов в БД;
* при необходимости по ходу работы над проектом уточнения и корректировки обсуждаются с техническим менеджером проекта.

## Что нужно сделать

Реализация полноценного финансового плагина. Доступ к основным настройкам и просмотру информации в отдельной вкладке "Финансы" в меню "Прочее" в веб-версии Easy Redmine. Необходимо предусмотреть наличие доступа в зависимости от роли пользователя.
Должно открываться главное окно (З/П и премии сотрудников), где справа сверху будет несколько кнопок, при нажатии на которые будет открываться соответствующее окно:

* З/П и премии сотрудников (оно же главное окно);
* финансы проектов;
* сводка финансов;
* статистика.

### Страница "З/П и премии сотрудников"

Представляет собой [страницу](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=16-196&m=dev&t=bG8mUnVZt1Aa8s0Z-1) с информацией в табличном виде, где показываются реальные (расчётные) заработные платы и премии по сотрудникам.
В таблице можно:

* фильтровать значения по месяцам (диапазон по умолчанию - текущий календарный год);
* фильтровать и сортировать значения списка сотрудников (по умолчанию, сортировка в алфавитном порядке по фамилии сотрудника, фильтр - участники группы "ТКЗ ИЦ СПб"):
  * фамилии;
  * имени;
  * должности;
  * группа;
* выбрать какие столбцы атрибутов "Проектов" будут показываться в таблице (Номер проекта, Проект, Наименование в 1С и т.п.).

Сама таблица на этой странице является нередактируемой.
![Таблица з/п и премий сотрудников](/docs/table_salaries_bonuses_employees.png)
Фактические значения "З/П" и "Доп. З/П" сотрудника в таблице являются расчётными:

* для сотрудников на полной ставке - З/П и Доп. З/П, которые вносятся на странице ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки) в столбцы "З/П" и "Доп. З/П" соответственно;  
* для сотрудников на неполной ставке - посчитанная З/П или Доп. З/П за месяц с учётом отработанных часов, которые рассчитываются таким образом:  
$$\frac{(Salary\ or\ AdditionalSalary) \cdot Hours_{employeeMonth}}{NormalHours_{month}},$$  
где $Salary$ - номинальная з/п сотрудника, которая вносится на странице ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки) в столбце "З/П";  
$AdditionalSalary$ - номинальная дополнительная з/п сотрудника, которая вносится на странице ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки) в столбце " Доп. З/П";  
$Hours_{employeeMonth}$ - кол-во отработанных часов сотрудника за данный месяц;  
$NormalHours_{month}$ - кол-во рабочих часов за данный месяц для 40 ч. рабочей недели согласно производственному календарю.

Значения премий (Премия 1 и Премия 2) заполняются автоматически значениями со [страницы "Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки) из столбцов "Премия 1" и "Премия 2" соответственно.

Значения отпускных отображаются ровно такими, какими их вводят на странице ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки) в столбце "Отпускные".

Последним столбцом в таблице является средний доход сотрудника в месяц за показываемый период времени, который автоматически рассчитывается:
$$SumSalaries + SumBonuses + SumHolidayFinance,$$  
где $SumSalaries$ - сумма фактических З/П и доп. З/П за этот период времени;  
$SumBonuses$ - сумма премий 1 и премий 2 за этот период времени;  
$SumHolidayFinance$ - сумма отпускных за этот период времени.

Внизу справа есть кнопки экспорта данной таблицы в формате xlsx, pdf: ![Footer export](/docs/footer_export.png)

Для этой страницы дополнительно справа есть кнопка:

* Редактировать таблицу З/П и премий.

При нажатии на кнопку "Редактировать таблицу З/П и премий" открывается страница ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки).

### Страница "Номинальные заработные платы и премии сотрудников на руки"

[Данная страница](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=169-2) уже представляет собой редактируемую таблицу з/п на руки в месяц и премий на руки за месяц.
Фильтры и сортировки в таблице сохраняются как на предыдущей странице; есть возможность их изменения.
Каждое значение З/П и премии можно редактировать вручную.
Однако в таблице значения З/П и доп. З/П по месяцам заполняются автоматически, когда наступает каждый новый месяц.  
Например, на момент 31 января в таблице заполнены З/П и доп. З/П за январь; при наступлении 1 февраля последние указанные суммы З/П и доп. З/П сотрудника за январь месяц автоматически записываются на З/П и доп. З/П за февраль соответственно.
![Редактируемая таблица з/п и премий сотрудников](/docs/edit_table_salaries_bonuses_employees.png)
Столбец "Средний доход за данный период" отсутствует.
Значения З/П для тех, кто на полной ставке и на неполной ставке, указываются такие, словно сотрудник работает на полной ставке.
Для этой страницы дополнительно справа есть кнопка:

* Сохранить.

Внизу справа есть кнопки экспорта данной таблицы в формате xlsx, pdf.

### Страница "Финансы проектов"

Представляет собой [страницу](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=48-2) с информацией в табличном виде, где показываются данные бюджетов проектов и их подпроектов.
Все значения в данной таблице являются нередактируемыми.
![Таблица финансов проектов](/docs/table_finances_projects.png)
Первые столбцы являются атрибутами "Проектов", например, "Номер проекта", "Проект" и "Наименование в 1С".
Далее идёт столбец под названием "Бюджет", который автоматически вычисляется:
$$StartBudget + AllTotalIncomes,$$
где $StartBudget$ - стартовый бюджет проекта;  
$AllTotalIncomes$ - сумма всех иных статей доходов проекта на текущий момент.

Далее идёт по 5 столбцов на каждый месяц в выбранном временном диапазоне:

* Бюджет на начало мес. - бюджет проекта на начало месяца, который вычисляется автоматически:
$$StartBudget + TotalIncomes - TotalExpenses,$$  
где $StartBudget$ - стартовый бюджет проекта;  
$TotalIncomes$ - сумма всех иных статей доходов проекта на момент начала данного месяца;  
$TotalExpenses$ - сумма всех статей расходов проекта на момент начала данного месяца;
* Расходы на З/П - вычисляется автоматически сумма статей расходов на з/п сотрудников, которые имеют затраченное время на проекте в данном месяце:
  * для сотрудников на полной ставке по формуле: $$\frac{Salary \cdot Hours_{projectMonth}}{Hours_{month}},$$  
  где $Salary$ - номинальная з/п сотрудника (из столбца "З/П" со страницы ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки));  
  $Hours_{projectMonth}$ - кол-во отработанных часов сотрудника за данный месяц на проекте;  
  $Hours_{month}$ - кол-во отработанных часов сотрудника за данный месяц;
  * для сотрудников на неполной ставке по формуле: $$\frac{Salary \cdot Hours_{projectMonth}}{NormalHours_{month}},$$  
  где $Salary$ - номинальная з/п сотрудника (из столбца "З/П" со страницы ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки));  
  $Hours_{projectMonth}$ - кол-во отработанных часов сотрудника за данный месяц на проекте;  
  $NormalHours_{month}$ - кол-во рабочих часов за данный месяц для 40 ч. рабочей недели согласно производственному календарю;
* Расходы на доп. З/П - полностью аналогично "Расходам на З/П" для столбца "Доп. З/П" со страницы ["Номинальные заработные платы и премии сотрудников на руки"](#страница-номинальные-заработные-платы-и-премии-сотрудников-на-руки)
* Расходы на премии 1 - сумма статей расходов на премии (Премии 1) сотрудников в месяце данного проекта - будет вноситься вручную пользователем;
* Расходы на премии 2 - сумма статей расходов на премии (Премии 2) сотрудников в месяце данного проекта - будет вноситься вручную пользователем;
* Расходы на отпускные - сумма статей расходов на отпускные сотрудников в месяце данного проекта - будет вноситься вручную пользователем;

Последними столбцами после всех месяце выбранного временной диапазона будут:

* Остаток бюджета на конец диапазона - остаток средств бюджета проекта на момент конца выбранного временного промежутка:
$$StartBudget + TotalIncomes_{endTimeInterval} - TotalExpenses_{endTimeInterval},$$  
где $StartBudget$ - стартовый бюджет проекта;  
$TotalIncomes_{endTimeInterval}$ - сумма всех иных статей доходов проекта на момент конца выбранного временного промежутка;  
$TotalExpenses_{endTimeInterval}$ - сумма всех статей расходов проекта на момент конца выбранного временного промежутка;
* Расходы в диапазоне - сумма статей расходов за выбранный временной промежуток;
* Итоговый остаток бюджета - остаток средств бюджета проекта на текущий момент:
$$StartBudget + AllTotalIncomes - AllTotalExpenses,$$
где $StartBudget$ - стартовый бюджет проекта;  
$AllTotalIncomes$ - сумма всех иных статей доходов проекта на текущий момент;
$AllTotalExpenses$ - сумма всех статей расходов проекта на текущий момент;
* Итого затраты - сумма всех статей расходов проекта на текущий момент.

В таблице можно через кнопки "Фильтры" и "Настройки" вверху страницы:

* выбрать рассматриваемый временной промежуток (промежуток по умолчанию - текущий календарный год);
* упорядочить значения списка проектов и отфильтровать список проектов и подпроектов;
* выбрать какие столбцы атрибутов "Проектов" будут показываться в таблице (Номер проекта, Проект, Наименование в 1С и т.п.).

Необходимо обеспечить ширины столбцов по умолчанию такие, чтобы на экране без прокрутки отображались данные по 2-3 месяцам.

В таблице отображаются как отдельные проекты, так и проекты с подпроектами.

Правила для проектов (родительских проектов) с подпроектами:

* первым идёт родительский проект, а сразу после его подпроекты;
* сгруппированы вместе;
* значения столбцов "Стартовый бюджет", "Бюджет на начало месяца", "Расходы на з/п сотрудников" и др. для строки родительского проекта получаются суммированием соответствующих значений строк подпроектов данного родительского проекта.

Для этой страницы дополнительно справа есть кнопки:

* Редактировать финансы проектов;
* Добавить доход в бюджет проекта;
* Добавить расход бюджета проекта.

Внизу справа есть кнопки экспорта данной таблицы в формате xlsx, pdf.

При нажатии на кнопку "Редактировать финансы проектов" открывается страница "Редактирование финансов проектов".

### Страница "Редактирование финансов проектов"

Представляет собой [страницу](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=191-14) с таблицей, где часть значений в таблице можно редактировать.
![Таблица редактирования финансов проектов](/docs/edit_table_finances_projects.png)

Редактируемыми значениями являются выделенные желтым цветом значения, а точнее:

* Расходы на премии 1;
* Расходы на премии 2;
* Расходы на отпускные.

Остальные значения заблокированы для изменения.
Справа имеется дополнительная кнопка "Сохранить".

При нажатии на кнопку "Добавить статью дохода в бюджет проекта" поверх открывается [всплывающее окно](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=213-2), в котором можно внести дополнительную статью дохода в бюджет проекта. Для этого в появившемся окне есть следующие поля:

* дата выделения статьи дохода проекта - обязательное поле;
* выбор проекта (атрибут "Проект"), бюджет которого пополняем (через раскрывающийся список + возможность ручного ввода) - обязательное поле;
* в описании должен быть указан текст, где должен быть указан номер документа или название работ, по которому вводится статья дохода - обязательное поле, справа есть соответствующая подсказка;
* сумма статьи дохода - обязательное поле.

При нажатии на кнопку "Добавить статью расхода бюджета проекта" поверх открывается [всплывающее окно](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=220-38), в котором можно внести дополнительную статью расхода бюджета проекта. Для этого в появившемся окне есть следующие поля:

* дата выделения статьи расхода бюджета проекта - обязательное поле;
* выбор проекта (атрибут "Проект"), из бюджета которого вычитаем расход (через раскрывающийся список + возможность ручного ввода) - обязательное поле;
* в описании должен быть указан текст, где должен быть указан номер документа или название работ, по которому вводится статья расхода - обязательное поле, справа есть соответствующая подсказка;
* сумма статьи расхода - обязательное поле.

### Страница "Сводка финансов"

[Данная страница](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=330-32) представляет собой сведение финансов проектов в табличном виде за весь промежуток времени, где строками являются как отдельные проекты, так и проекты с подпроектами, а столбцами - различные финансовые значения проектов.
![Таблица Сводка финансов проектов](/docs/table_summary_of_finance.png)

Правила для проектов (родительских проектов) с подпроектами:

* первым идёт родительский проект, а сразу после его подпроекты;
* сгруппированы вместе;
* значения столбцов "Бюджет", "Стартовый бюджет" и др. для строки родительского проекта получаются суммированием соответствующих значений строк подпроектов данного родительского проекта.

Обязательные столбцы таблицы:

* Номер проекта;
* Проект - имя проекта;
* Бюджет (Budget): $StartBudget + AllTotalIncomes - AllTotalExpenses,$  
где $AllTotalIncomes$ - сумма всех иных статей доходов проекта (№1, №2 и др.) за выбранный промежуток времени;
* Стартовый бюджет (StartBudget) - бюджет проекта на старте;
* Статья дохода №1, №2 и др. - суммы дополнительных статей доходов проекта в хронологическом порядке их добавления у каждого проекта за выбранный промежуток времени;
* Итого расходы (TotalExpenses) - сумма всех расходов проекта (на З/П, на премии и иные статьи расхода) за выбранный промежуток времени;
* Расходы на З/П - сумма всех расходов проекта на З/П сотрудникам за выбранный промежуток времени;
* Расходы на премии - сумма всех расходов проекта на премии сотрудникам за выбранный промежуток времени;
* Статья расхода №1, №2 и др. - суммы дополнительных статей расходов проекта в хронологическом порядке их добавления у каждого проекта за выбранный промежуток времени;
* Остаток бюджета (BalanceBudget) - остаток бюджета проекта на момент окончания выбранного промежутка времени: $Budget - TotalExpenses.$

В таблице можно через кнопки "Фильтры" и "Настройки" вверху страницы:

* выбрать рассматриваемый промежуток времени (промежуток по умолчанию - с 01.01.2018 по текущий момент);
* упорядочить значения списка проектов и отфильтровать список проектов и подпроектов;
* выбрать какие столбцы атрибутов "Проектов" будут показываться в таблице (Номер проекта, Проект, Наименование в 1С и т.п.).

Внизу справа есть кнопки экспорта данной таблицы в формате xlsx, pdf.

### Страница "Статистика"

Здесь будет [окно со статистикой среднемесячного дохода сотрудника по годам](https://www.figma.com/design/InItq3Ywyfz5n2juZiQldq/Finance-projects-Redmine-Plugin?node-id=240-2).
Таблица представляет собой значения среднемесячного дохода каждого сотрудника за календарные года.
![Таблица среднемесячного дохода сотрудников](/docs/table_average_income_employees.png)
Все значения в данной таблице являются нередактируемыми - автоматически вычисляются для каждого календарного года по формуле:
$$\frac{Summ_{salariesYear} + Summ_{bonusesYear}}{NumMonths},$$  
где $Summ_{salariesYear}$ - сумма заработных плат сотрудника за этот календарный год;  
$Summ_{bonusesYear}$ - сумма премий сотрудника за этот календарный год;  
$NumMonths$ - число прошедших полных месяцев этого календарного года:

* для предыдущих годов - 12;
* для текущего года - кол-во прошедших полных месяцев, например, если текущая дата 18.04.2025, то для 2025 года количество полных прошедших месяцев будет равно 3.

В таблице можно через кнопки "Фильтры" и "Настройки" вверху страницы:

* выбрать диапазон рассматриваемых годов (диапазон по умолчанию - текущий и предыдущий календарный год);
* фильтровать и сортировать значения списка сотрудников (по умолчанию, сортировка в алфавитном порядке по фамилии сотрудника, фильтр - участники группы "ТКЗ ИЦ СПб"):
  * фамилии;
  * имени;
  * должности;
  * группа;
* выбрать какие столбцы атрибутов сотрудника будут показываться в таблице (фамилия, имя, отчество, должность, группа и т.п.).

Внизу справа есть кнопки экспорта данной таблицы в формате xlsx, pdf.
